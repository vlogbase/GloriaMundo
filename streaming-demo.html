<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GloriaMundo Streaming Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    
    h1 {
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .chat-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      padding: 15px;
      background-color: #f9f9f9;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
    }
    
    .user-message {
      background-color: #e1f5fe;
      margin-left: 20px;
      margin-right: 5px;
      text-align: right;
    }
    
    .assistant-message {
      background-color: #f0f0f0;
      margin-right: 20px;
      margin-left: 5px;
    }
    
    .input-container {
      display: flex;
      padding: 10px;
      background-color: #fff;
      border-top: 1px solid #ddd;
    }
    
    #message-input {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
    
    button {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #0b7dda;
    }
    
    .status {
      color: #666;
      font-style: italic;
      margin-top: 10px;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #2196F3;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>GloriaMundo Streaming Demo</h1>
  
  <p>This page demonstrates the streaming functionality in the GloriaMundo chat application. Type a message and send it to see the AI response appear character by character.</p>
  
  <div class="chat-container">
    <div class="chat-messages" id="chat-messages">
      <div class="message assistant-message">
        Hello! I'm the GloriaMundo streaming demo. Send me a message to see the streaming response in action.
      </div>
    </div>
    
    <div class="input-container">
      <input type="text" id="message-input" placeholder="Type your message here..." />
      <button id="send-button">Send</button>
    </div>
  </div>
  
  <div class="status" id="status"></div>
  
  <script>
    // DOM elements
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const statusElement = document.getElementById('status');
    
    // Chat state
    let conversationId = 1; // Demo conversation ID
    let isStreaming = false;
    
    // Add a user message to the chat
    function addUserMessage(content) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message user-message';
      messageElement.textContent = content;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Add an assistant message to the chat
    function addAssistantMessage(content = '', messageId = null) {
      // Create or update the message
      let messageElement;
      
      if (messageId) {
        // Try to find existing message with this ID
        messageElement = document.getElementById(`message-${messageId}`);
      }
      
      if (!messageElement) {
        // Create new message element
        messageElement = document.createElement('div');
        messageElement.className = 'message assistant-message';
        if (messageId) {
          messageElement.id = `message-${messageId}`;
        }
        chatMessages.appendChild(messageElement);
      }
      
      // Update content
      messageElement.textContent = content;
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageElement;
    }
    
    // Update status
    function updateStatus(message, isLoading = false) {
      statusElement.textContent = message;
      
      // Remove existing loading spinner if present
      const existingSpinner = statusElement.querySelector('.loading');
      if (existingSpinner) {
        existingSpinner.remove();
      }
      
      // Add loading spinner if requested
      if (isLoading) {
        const loadingSpinner = document.createElement('span');
        loadingSpinner.className = 'loading';
        statusElement.appendChild(loadingSpinner);
      }
    }
    
    // Stream a response from the server
    async function streamResponse(content) {
      if (isStreaming) {
        updateStatus('Already streaming a response');
        return;
      }
      
      isStreaming = true;
      updateStatus('Streaming response...', true);
      
      try {
        // Create the SSE connection
        const params = new URLSearchParams();
        params.append('content', content);
        
        // Create EventSource for streaming
        const streamUrl = `/api/conversations/${conversationId}/messages/stream?${params.toString()}`;
        const eventSource = new EventSource(streamUrl);
        
        let assistantMessageId = null;
        let assistantMessageContent = '';
        
        // Handle incoming stream data
        eventSource.onmessage = (event) => {
          try {
            // Check for done signal
            if (event.data === '[DONE]') {
              console.log('Stream complete');
              updateStatus('Streaming complete');
              eventSource.close();
              isStreaming = false;
              return;
            }
            
            // Parse the data
            const parsedData = JSON.parse(event.data);
            
            // Check if this is the first message with ID
            if (!assistantMessageId && parsedData.id) {
              assistantMessageId = parsedData.id;
              // Initialize empty message
              addAssistantMessage('', assistantMessageId);
            }
            
            // Process content delta
            const deltaContent = parsedData.choices?.[0]?.delta?.content;
            if (deltaContent) {
              assistantMessageContent += deltaContent;
              addAssistantMessage(assistantMessageContent, assistantMessageId);
            }
          } catch (error) {
            console.error('Error processing stream data:', error);
          }
        };
        
        // Handle connection opened
        eventSource.onopen = () => {
          console.log('Stream connection opened');
          updateStatus('Connected to stream', true);
        };
        
        // Handle errors
        eventSource.onerror = (error) => {
          console.error('Stream error:', error);
          updateStatus('Error in stream: ' + (error.message || 'Unknown error'));
          eventSource.close();
          isStreaming = false;
          
          // If no message was received, show a fallback message
          if (!assistantMessageId) {
            addAssistantMessage('Sorry, there was an error processing your request.');
          }
        };
      } catch (error) {
        console.error('Error setting up streaming:', error);
        updateStatus('Failed to set up streaming: ' + error.message);
        isStreaming = false;
      }
    }
    
    // Handle send button click
    sendButton.addEventListener('click', () => {
      const content = messageInput.value.trim();
      if (!content) return;
      
      // Add user message
      addUserMessage(content);
      
      // Clear input
      messageInput.value = '';
      
      // Stream response
      streamResponse(content);
    });
    
    // Handle enter key press
    messageInput.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });
    
    // Initialize
    updateStatus('Ready to chat');
  </script>
</body>
</html>